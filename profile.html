<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Profil - InfoPoinUnklab</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://kit.fontawesome.com/6d5d80ba30.js" crossorigin="anonymous"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
</head>
<body onload="loadProfile()">
<div class="header" data-aos="fade-down">
    <div class="header-left">
    <img src="logounklab.png" alt="UNKLAB Logo" class="logo">
    <h3>INFO POINT UNKLAB</h3>
    </div>
    <div class="profil">
    <div style="text-align:right;">
        <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">Selamat Datang:</div>
        <span id="nama-user">Nama</span>
    </div>
    <span id="site-inbox-badge" style="display:inline-block; margin-left:8px; background:#ff3b30; color:#fff; padding:2px 8px; border-radius:12px; font-size:12px; vertical-align:middle;">0</span>
    <button class="btn-logout" onclick="handleLogout()">Logout</button>
    </div>
</div>

<div class="container" data-aos="fade-up" data-aos-delay="80">
    <h2>Profil Saya</h2>

    <div class="form-group" data-aos="fade-up" data-aos-delay="100">
        <label>Nama</label>
        <input id="profile-nama" disabled aria-disabled="true" />
        <small style="display:block; color:var(--muted); margin-top:6px; font-size: smaller;">Nama terdaftar tidak dapat diubah melalui halaman ini.</small>
    </div>

    <div class="form-group" data-aos="fade-up" data-aos-delay="120">
        <label>NIM</label>
        <input id="profile-nim" disabled />
    </div>

    <div class="form-group" data-aos="fade-up" data-aos-delay="140">
        <label>Email</label>
        <input id="profile-email" />
    </div>

    <div class="form-group" data-aos="fade-up" data-aos-delay="160">
        <label>Fakultas / Jurusan</label>
        <input id="profile-fakultas" />
    </div>

    <div class="form-group" data-aos="fade-up" data-aos-delay="180">
        <label>Telepon</label>
        <input id="profile-phone" />
    </div>

    <div style="display:flex; gap: 8px; margin-top:8px;" data-aos="fade-up" data-aos-delay="200">
        <button class="btn btn-sukses" onclick="saveProfileFromForm()">Simpan</button>
        <a class="btn" href="dashboard.html">Kembali</a>
    </div>

    <hr style="margin:20px 0;" data-aos="fade-up" data-aos-delay="220">

    <h3 data-aos="fade-up" data-aos-delay="240">Ringkasan Poin</h3>
    <p data-aos="fade-up" data-aos-delay="260">Total Poin: <strong id="summary-poin">0</strong></p>
    <p data-aos="fade-up" data-aos-delay="280">Ranking: <strong id="summary-ranking">-</strong></p>

    <h4 data-aos="fade-up" data-aos-delay="300">Poin per Kategori</h4>
    <div id="kategori-poin" data-aos="fade-up" data-aos-delay="320"></div>
</div>

<script src="app.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    AOS.init({ once: true, duration: 700, easing: 'ease-out-cubic' });

    function detectCategory(text) {
        if (!text) return 'Other';
        const s = text.toLowerCase();
        if (s.includes('sabat')) return 'Sabat';
        if (s.includes('mid') || s.includes('mid-week') || s.includes('mid week')) return 'Mid Week';
        if (s.includes('vesper')) return 'Vesper';
        if (s.includes('pelanggaran') || s.includes('poin') || s.includes('poin')) return 'Pelanggaran';
        return 'Other';
    }

    function loadProfile(){
        const user = getCurrentUser();
        if (!user) return window.location.href='index.html';
        document.getElementById('nama-user').textContent = user.nama || '';
        document.getElementById('profile-nama').value = user.nama || '';
        document.getElementById('profile-nim').value = user.nim || '';

        const users = getUsers();
        const me = users.find(u=>u.nim===user.nim);
        if (me) {
        document.getElementById('profile-email').value = me.email || '';
        document.getElementById('profile-fakultas').value = me.fakultas || '';
        document.getElementById('profile-phone').value = me.phone || '';
    }

      // summary
        const logs = getLogsForUser(user.nim);
        const master = getMasterPelanggaran();
        const total = logs.reduce((acc,l)=> acc + ((master.find(m=>m.id===l.id_pelanggaran)||{poin:0}).poin || 0), 0);
        document.getElementById('summary-poin').textContent = total;
        const leaderboard = getLeaderboard(50);
        const pos = leaderboard.findIndex(r => r.nim === user.nim);
        document.getElementById('summary-ranking').textContent = (pos >= 0 ? (pos+1) : '-');

    const catTotals = { 'Sabat':0, 'Mid Week':0, 'Vesper':0, 'Pelanggaran':0, 'Other':0 };
    logs.forEach(l => {
        const p = master.find(m => m.id === l.id_pelanggaran) || {nama:'Unknown', poin:0};
        const cat = detectCategory(l.keterangan || p.nama || '');
        catTotals[cat] = (catTotals[cat] || 0) + (p.poin || 0);
    });

    const el = document.getElementById('kategori-poin');
    el.innerHTML = '<table style="width:100%; border-collapse:collapse; text-align:left;">' +
        '<thead><tr><th>Kategori</th><th>Poin</th></tr></thead><tbody>' +
        Object.keys(catTotals).map(k=>`<tr><td>${k}</td><td style="text-align:right">${catTotals[k]}</td></tr>`).join('') +
        '</tbody></table>';

        const b = document.getElementById('site-inbox-badge');
        if (b) b.textContent = getUnreadCount();
    }

    function saveProfileFromForm(){
        const nim = document.getElementById('profile-nim').value;
      // Do not allow changing the name from the profile page; keep current name as-is
        const cur = getCurrentUser() || {};
        const updated = {
        nim,
        // Keep nama from current user so it won't be overwritten
        nama: cur.nama || document.getElementById('profile-nama').value,
        email: document.getElementById('profile-email').value,
        fakultas: document.getElementById('profile-fakultas').value,
        phone: document.getElementById('profile-phone').value
    };
      // Alternatively, we could omit 'nama' from updated entirely; keeping it prevents accidental overwrites
    saveProfile(updated);
    if (cur && cur.nim === nim) {
        // Keep current name unchanged; update other fields on current_user
        cur.email = updated.email;
        cur.fakultas = updated.fakultas;
        cur.phone = updated.phone;
        localStorage.setItem('current_user', JSON.stringify(cur));
    }
        alert('Profil tersimpan');
        loadProfile();
    }

    function handleLogout(){ localStorage.removeItem('current_user'); window.location.href = 'index.html'; }
</script>
</body>
</html>